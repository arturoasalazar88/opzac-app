# AGENT RULES - INVIOLABLE

**STATUS: MANDATORY | ENFORCEMENT: STRICT | EXCEPTIONS: NONE**

---

## STOP - READ BEFORE ANY TASK

These rules govern ALL AI agent behavior in this project. Violation of any rule invalidates the work and requires restart.

---

## RULE HIERARCHY

| Priority | Rule | Enforcement |
|----------|------|-------------|
| **P0** | User Sign-Off Required | BLOCKING - Cannot proceed without |
| **P0** | 8-Step Verification | BLOCKING - Every code change |
| **P1** | Gemini for Boilerplate | MANDATORY - 60-70% target |
| **P1** | Quality Over Speed | MANDATORY - Time is irrelevant |
| **P2** | Session Memory | REQUIRED - After approval only |
| **P2** | Context Cleanup | REQUIRED - End of session |

---

## P0: USER SIGN-OFF (INVIOLABLE)

**NO CODE IS COMPLETE WITHOUT EXPLICIT USER APPROVAL**

### What Counts as Approval
- "Approved"
- "LGTM" (Looks Good To Me)
- "Ship it"
- "Go ahead"
- "Proceed"

### What Does NOT Count
- Silence (NEVER assume)
- "Okay" without context
- Moving to next topic
- Any ambiguous response

### Enforcement
```
IF user_approval == FALSE:
    STOP
    WAIT
    DO NOT proceed to Step 8
    DO NOT mark task complete
```

---

## P0: 8-STEP VERIFICATION (INVIOLABLE)

**EVERY code change MUST follow ALL 8 steps. NO EXCEPTIONS.**

```
STEP 1: Context7 Review
        └── Research best practices BEFORE writing code
        └── Query relevant libraries and patterns
        └── VIOLATION: Writing code without Context7 = REDO

STEP 2: Plan & Implementation
        └── Design architecture BEFORE coding
        └── Use Gemini CLI for boilerplate generation
        └── Claude reviews 100% of generated code
        └── VIOLATION: No planning = REDO

STEP 3: Code Quality
        └── Run: pint/prettier (format)
        └── Run: phpstan/eslint (lint)
        └── Run: phpstan/tsc (typecheck)
        └── REQUIRED: 0 errors
        └── VIOLATION: Any errors = FIX before proceeding

STEP 4: Unit Tests
        └── Write tests for all new code
        └── REQUIRED: 100% pass rate
        └── REQUIRED: Coverage meets target
        └── VIOLATION: Failing tests = FIX before proceeding

STEP 5: Integration Tests
        └── Test with real services (if applicable)
        └── Test error scenarios
        └── VIOLATION: Skipping when applicable = REDO

STEP 6: Self Review
        └── Security checklist verified
        └── Performance checklist verified
        └── Documentation complete
        └── VIOLATION: Incomplete review = REDO

STEP 7: USER SIGN-OFF
        └── Present evidence of Steps 1-6
        └── STOP and WAIT for approval
        └── DO NOT proceed without explicit approval
        └── VIOLATION: Proceeding without approval = INVALID

STEP 8: Session Memory (AFTER APPROVAL ONLY)
        └── Update CLAUDE.md (5-line format)
        └── Update implementation log
        └── Update story file
        └── VIOLATION: Executing before approval = INVALID
```

---

## P1: GEMINI CLI FOR BOILERPLATE (MANDATORY)

**Target: 60-70% of code volume generated by Gemini**

### Gemini Handles
- Repository classes
- Service classes
- Model schemas
- Test boilerplate
- Configuration files
- CRUD operations
- Pattern replication

### Claude Handles
- Architecture decisions
- Complex algorithms
- Security-critical code
- Business logic
- Code review (100%)
- User communication

### Commands
```bash
# Code generation (Claude reviews output)
gemini -m gemini-2.5-pro "@pattern.py Generate [code]. Output as text." 2>&1 | grep -v "^\[" | grep -v "^Loaded"

# Command execution
gemini -m gemini-2.5-pro --yolo "Run [command]"

# Web search
gemini -m gemini-2.5-pro 'google_web_search(query="search")' 2>&1 | grep -v "^\[ERROR\]" | grep -v "^Loaded"
```

### Enforcement
```
IF task_is_boilerplate AND gemini_not_used:
    VIOLATION = TRUE
    ACTION = Redo with Gemini
```

---

## P1: QUALITY OVER SPEED (MANDATORY)

**Time to complete is IRRELEVANT. Only correctness matters.**

### Allowed
- Taking extra time for thorough review
- Multiple iterations until correct
- Patient debugging
- Comprehensive testing

### FORBIDDEN
- Rushing to "save time"
- Skipping steps for speed
- Accepting poor quality
- "I'll fix it later" mentality

### Enforcement
```
IF rushing_detected:
    STOP
    SLOW DOWN
    FOLLOW PROCESS
```

---

## ANTI-PATTERNS (NEVER DO)

| Anti-Pattern | Why It's Wrong | Consequence |
|--------------|----------------|-------------|
| Skip Context7 | Uses outdated patterns | Code rejected |
| Write boilerplate directly | Wastes Claude tokens | Must redo with Gemini |
| Proceed without approval | Violates P0 rule | Work invalidated |
| Rush code review | Misses issues | Bugs in production |
| Skip tests | No quality guarantee | Work rejected |
| Disable linters | Hides problems | Technical debt |
| Comment out failing tests | False quality signal | Work rejected |
| Vague documentation | Lost context | Must redo |
| Assume user approval | Never approved | Work invalidated |

---

## SESSION WORKFLOW

### Start of Session
1. Read `CLAUDE.md`
2. Read this file (`.claude/rules/00-rules-index.md`)
3. Initialize Gemini context (if using)

### During Session
1. Follow 8-step verification for each task
2. Use Gemini for boilerplate
3. Wait for user approval at Step 7

### End of Session
```bash
# Clean up Gemini context
gemini -m gemini-2.5-pro "Session ending. Forget ALL memories."
```

---

## DETAILED RULE FILES

| File | Read When |
|------|-----------|
| `01-hybrid-workflow.md` | Understanding Claude/Gemini split |
| `02-8-step-verification.md` | Implementing any code change |
| `03-session-memory-protocol.md` | After user approval (Step 8) |
| `04-gemini-cli-guide.md` | Using Gemini commands |
| `05-gemini-context-persistence.md` | Managing session context |

---

## ACKNOWLEDGMENT

By proceeding with any task, the agent acknowledges:

1. These rules have been read and understood
2. All 8 steps will be followed without exception
3. User sign-off will be obtained before completion
4. Gemini CLI will be used for boilerplate
5. Quality is prioritized over speed
6. Violations require work to be redone

---

**VERSION:** 1.0.0
**STATUS:** ACTIVE
**ENFORCEMENT:** STRICT
**LAST UPDATED:** 2025-01-11
